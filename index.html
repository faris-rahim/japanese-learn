<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japanese Learning Tracker</title>
    <link rel="stylesheet" href="japanese-learning.css">
    <!-- Supabase JS Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üáØüáµ Japanese Learning Tracker</h1>
            <p class="subtitle">Master Hiragana, Katakana, Kanji & Vocabulary</p>
        </header>

        <div class="main-content">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
                <button class="tab-btn" onclick="switchTab('hiragana')">„ÅÇ Hiragana Quiz</button>
                <button class="tab-btn" onclick="switchTab('katakana')">„Ç¢ Katakana Quiz</button>
                <button class="tab-btn" onclick="switchTab('vocabulary')">üìö Vocabulary Quiz</button>
                <button class="tab-btn" onclick="switchTab('study')">üìñ Study Guide</button>
                <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #333;">Your Progress</h2>
                <div class="progress-section">
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>Hiragana Mastery</span>
                            <span id="hiragana-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="hiragana-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>Katakana Mastery</span>
                            <span id="katakana-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="katakana-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="progress-item">
                        <div class="progress-label">
                            <span>Vocabulary Progress</span>
                            <span id="vocabulary-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="vocabulary-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Questions</div>
                        <div class="stat-value" id="total-questions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Correct Answers</div>
                        <div class="stat-value" id="total-correct">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Accuracy Rate</div>
                        <div class="stat-value" id="accuracy-rate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Study Streak</div>
                        <div class="stat-value" id="study-streak">0</div>
                    </div>
                </div>
            </div>

            <!-- Hiragana Quiz Tab -->
            <div id="hiragana" class="tab-content">
                <div class="quiz-section">
                    <h2 style="margin-bottom: 20px; color: #333;">Hiragana Quiz</h2>
                    <div class="score-display">
                        Score: <span id="hiragana-score">0</span> / <span id="hiragana-total">0</span>
                    </div>
                    <div class="quiz-card" id="hiragana-quiz-card">
                        <div class="japanese-text" id="hiragana-question">„ÅÇ</div>
                        <div class="options" id="hiragana-options"></div>
                    </div>
                    <div id="hiragana-feedback" class="feedback" style="display: none;"></div>
                    <button class="btn" onclick="startQuiz('hiragana')">Start Quiz</button>
                    <button class="btn" onclick="nextQuestion('hiragana')" id="hiragana-next" style="display: none;">Next Question</button>
                </div>
            </div>

            <!-- Katakana Quiz Tab -->
            <div id="katakana" class="tab-content">
                <div class="quiz-section">
                    <h2 style="margin-bottom: 20px; color: #333;">Katakana Quiz</h2>
                    <div class="score-display">
                        Score: <span id="katakana-score">0</span> / <span id="katakana-total">0</span>
                    </div>
                    <div class="quiz-card" id="katakana-quiz-card">
                        <div class="japanese-text" id="katakana-question">„Ç¢</div>
                        <div class="options" id="katakana-options"></div>
                    </div>
                    <div id="katakana-feedback" class="feedback" style="display: none;"></div>
                    <button class="btn" onclick="startQuiz('katakana')">Start Quiz</button>
                    <button class="btn" onclick="nextQuestion('katakana')" id="katakana-next" style="display: none;">Next Question</button>
                </div>
            </div>

            <!-- Vocabulary Quiz Tab -->
            <div id="vocabulary" class="tab-content">
                <div class="quiz-section">
                    <h2 style="margin-bottom: 20px; color: #333;">Vocabulary Quiz</h2>
                    <div class="score-display">
                        Score: <span id="vocabulary-score">0</span> / <span id="vocabulary-total">0</span>
                    </div>
                    <div class="quiz-card" id="vocabulary-quiz-card">
                        <div class="japanese-text" id="vocabulary-question">„Åì„Çì„Å´„Å°„ÅØ</div>
                        <div class="options" id="vocabulary-options"></div>
                    </div>
                    <div id="vocabulary-feedback" class="feedback" style="display: none;"></div>
                    <button class="btn" onclick="startQuiz('vocabulary')">Start Quiz</button>
                    <button class="btn" onclick="nextQuestion('vocabulary')" id="vocabulary-next" style="display: none;">Next Question</button>
                </div>
            </div>

            <!-- Study Guide Tab -->
            <div id="study" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">Study Guide</h2>
                
                <h3 style="margin: 20px 0; color: #667eea;">Hiragana Characters</h3>
                <div class="study-list" id="hiragana-study"></div>

                <h3 style="margin: 20px 0; color: #667eea;">Katakana Characters</h3>
                <div class="study-list" id="katakana-study"></div>

                <h3 style="margin: 20px 0; color: #667eea;">Common Vocabulary</h3>
                <div class="study-list" id="vocabulary-study"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">Settings</h2>
                <div class="settings-section">
                    <div class="setting-item">
                        <label class="setting-label">Questions Per Quiz</label>
                        <input type="number" id="questions-per-quiz" min="5" max="50" value="10" onchange="saveSettings()">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Difficulty Level</label>
                        <select id="difficulty-level" onchange="saveSettings()">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Study Goal (minutes per day)</label>
                        <input type="number" id="study-goal" min="5" max="180" value="20" onchange="saveSettings()">
                    </div>
                    <button class="btn reset-btn" onclick="resetProgress()">Reset All Progress</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration (embedded to avoid MIME type issues on Netlify)
        // Uses hardcoded values for simplicity (anon key is safe for browser use)
        const SUPABASE_URL = 'https://gwcoprcytfgvjzzuwnic.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd3Y29wcmN5dGZndmp6enV3bmljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4OTY1ODIsImV4cCI6MjA3NzQ3MjU4Mn0.yD92KbNIKOZJpQWhv7VmQvls9IhR9kScAyegl-aGMQw';

        // Initialize Supabase client
        let supabase;

        try {
            if (typeof window.supabase !== 'undefined') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('‚úì Supabase connected successfully');
            } else {
                console.error('Supabase library not loaded. Make sure the CDN script is included.');
            }
        } catch (error) {
            console.error('Error initializing Supabase:', error);
        }

        // Database helper functions
        const db = {
            async getProgress(userId) {
                try {
                    const { data, error } = await supabase
                        .from('user_progress')
                        .select('*')
                        .eq('user_id', userId)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    return data;
                } catch (error) {
                    console.error('Error fetching progress:', error);
                    return null;
                }
            },

            async saveProgress(userId, progressData) {
                try {
                    const { data, error } = await supabase
                        .from('user_progress')
                        .upsert({
                            user_id: userId,
                            hiragana_correct: progressData.hiragana.correct,
                            hiragana_total: progressData.hiragana.total,
                            katakana_correct: progressData.katakana.correct,
                            katakana_total: progressData.katakana.total,
                            vocabulary_correct: progressData.vocabulary.correct,
                            vocabulary_total: progressData.vocabulary.total,
                            total_questions: progressData.totalQuestions,
                            total_correct: progressData.totalCorrect,
                            streak: progressData.streak,
                            last_study_date: progressData.lastStudyDate,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'user_id' })
                        .select();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error saving progress:', error);
                    return null;
                }
            },

            async getSettings(userId) {
                try {
                    const { data, error } = await supabase
                        .from('user_settings')
                        .select('*')
                        .eq('user_id', userId)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') throw error;
                    return data;
                } catch (error) {
                    console.error('Error fetching settings:', error);
                    return null;
                }
            },

            async saveSettings(userId, settingsData) {
                try {
                    const { data, error } = await supabase
                        .from('user_settings')
                        .upsert({
                            user_id: userId,
                            questions_per_quiz: settingsData.questionsPerQuiz,
                            difficulty: settingsData.difficulty,
                            study_goal: settingsData.studyGoal,
                            updated_at: new Date().toISOString()
                        }, { onConflict: 'user_id' })
                        .select();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error saving settings:', error);
                    return null;
                }
            },

            async logQuizSession(userId, quizData) {
                try {
                    const { data, error } = await supabase
                        .from('quiz_sessions')
                        .insert({
                            user_id: userId,
                            quiz_type: quizData.type,
                            score: quizData.score,
                            total_questions: quizData.total,
                            accuracy: (quizData.score / quizData.total) * 100,
                            completed_at: new Date().toISOString()
                        })
                        .select();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error logging quiz session:', error);
                    return null;
                }
            },

            async getQuizHistory(userId, limit = 10) {
                try {
                    const { data, error } = await supabase
                        .from('quiz_sessions')
                        .select('*')
                        .eq('user_id', userId)
                        .order('completed_at', { ascending: false })
                        .limit(limit);

                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Error fetching quiz history:', error);
                    return [];
                }
            },

            async signUp(email, password) {
                try {
                    const { data, error } = await supabase.auth.signUp({ email, password });
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error signing up:', error);
                    return null;
                }
            },

            async signIn(email, password) {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error signing in:', error);
                    return null;
                }
            },

            async signOut() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                    return true;
                } catch (error) {
                    console.error('Error signing out:', error);
                    return false;
                }
            },

            async getCurrentUser() {
                try {
                    const { data: { user }, error } = await supabase.auth.getUser();
                    if (error) throw error;
                    return user;
                } catch (error) {
                    console.error('Error getting current user:', error);
                    return null;
                }
            }
        };

        window.db = db;
    </script>
    <script src="japanese-learning.js"></script>
</body>
</html>
